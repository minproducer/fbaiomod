import{bf as e,r as i,b3 as n,b8 as a}from"./index-BoH2j3cU.js";import{d as t,u as s,a as o,t as r,g as l,c as d,b as c,T as m,S as p,I as h,h as g,i as u,o as x}from"./MyApp-D93h0aQZ.js";import{E as j}from"./ExportButton-bON9fXxS.js";import v from"./useCacheState-CRWoF5gI.js";import{g as f,a as y,s as w}from"./messages-BuA_OyFY.js";import{checkVIP as k}from"./useVIP-f__zpoad.js";import{a as b}from"./file-download-DzcmM7_q.js";import{d as C}from"./dayjs.min-BtTaSKBf.js";import{B as D}from"./BadgeWrapper-D2jAMD-I.js";import N from"./MyTable-B-PXqHUM.js";import{R as T}from"./row-B1CxNhq6.js";import{D as I}from"./index-DWB43XHw.js";import{A as M}from"./index-BMF_2O9_.js";import"./sweetalert2.esm.all-BZxvatOx.js";import"./getIds-CXkkWBEB.js";import"./index-7X6rB-D6.js";import"./SearchOutlined-BUONfEHJ.js";import"./index-IueWr_3q.js";import"./Dropdown-C4ZC00F-.js";import"./index-CLQrWQaN.js";import"./index-DFDl0PJq.js";import"./DownOutlined-DRGhK8zp.js";import"./Table-CSd7eQib.js";import"./List-BGWr2xJE.js";import"./index-BaNQURuW.js";import"./index-BS-7HFpi.js";import"./index-p3GZU5lJ.js";import"./index-CTitp5Qg.js";import"./PurePanel-DNUOZ5MP.js";import"./index-UsPtaxTh.js";import"./move-DCq-oE7y.js";import"./useBreakpoint-CUrvcDr2.js";import"./Pagination-CIrtJa5e.js";import"./index-DD15UiBp.js";const{Title:S}=d,A=e=>{const i=new Set;return e.map((e=>e.isGroup?e.participants.map((e=>({uid:e.id,name:e.name}))):{uid:e.id,name:e.name})).flat().forEach((({uid:e,name:n})=>{i.has(e)||i.add({uid:e,name:n})})),Array.from(i.values())};function F(e){return"-no data-"==e.name||"Người dùng Facebook"==e.name}function L(){const{message:d,notification:L}=t(),{ti:G}=s(),E=e(),{profile:P}=o(),[_,B]=v("AllMessages.data",[]),[H,q]=i.useState(!1);i.useEffect((()=>{(null==_?void 0:_.length)||z()}),[]);const z=()=>{if(H)return;const e="AllMessages:onClickReload";r(e),d.loading({key:e,duration:0,content:G({en:"Fetching messages...",vi:"Đang tải tin nhắn"})}),q(!0),f().then((i=>{if(console.log(i),!(null==i?void 0:i.length))return d.error({key:e,content:G({en:"No data to show",vi:"Không có dữ liệu"})});B(i),d.success({key:e,content:G({en:"Fetch messages completed",vi:"Tải xong tin nhắn"})})})).catch((i=>{d.error({key:e,content:G({en:"Failed to fetch messages",vi:"Lỗi tải tin nhắn"})+": "+i.message}),console.log(i)})).finally((()=>{q(!1)}))},O=e=>()=>{var i,n,a,t;r("AllMessages:onClickFirstMessages"),E("/messages/first",{state:{threadId:e.id||(null==(n=null==(i=null==e?void 0:e.participants)?void 0:i[0])?void 0:n.id),threadName:e.name||(null==(t=null==(a=null==e?void 0:e.participants)?void 0:a[0])?void 0:t.name)}})},R=async e=>{if(!(await k()))return;const i="AllMessages:onClickDownloadThread";r(i);const a=e.name,t=i+e.id;d.loading({key:t,duration:0,content:G({en:"Downloading messages...",vi:"Đang tải tin nhắn..."})+a});let s=!1;const o=await y({threadId:e.id,checkStopFn:()=>s,progressCallback:e=>{d.loading({key:t,duration:0,content:n.jsxs(n.Fragment,{children:[G({en:"Downloading messages... ",vi:"Đang tải tin nhắn... "})+a,n.jsx("br",{}),e.length,G({en:" messages",vi:" tin nhắn"}),n.jsx("br",{}),C(e[0].time).format("YYYY-MM-DD HH:mm:ss"),n.jsx("br",{}),n.jsx("i",{children:G({en:"Click to stop",vi:"Bấm để dừng"})})]}),onClick:()=>{d.loading({key:t,duration:0,content:G({en:"Stopping...",vi:"Đang dừng..."})}),s=!0}})}});d.destroy(t),L.open({type:"success",duration:0,message:G(s?{en:"Download stopped: ",vi:"Đã dừng tải: "}:{en:"Download completed: ",vi:"Tải xong: "})+a,description:o.length+G({en:" messages",vi:" tin nhắn"})});const l=w({threadId:e.id||"",threadName:a,myUid:(null==P?void 0:P.uid)||"",msgs:o});return b(l,a+".html"),s},X=[{title:"#",key:"recent",dataIndex:"recent",sorter:(e,i)=>e.recent-i.recent,render:(e,i,n)=>i.recent+1,width:70,align:"center",headerAlign:"center"},{title:G({en:"Name",vi:"Tên"}),dataIndex:"name",key:"name",sorter:(e,i)=>e.name.localeCompare(i.name),render:(e,i,a)=>{var t,s,o,r,l,d,c,m;return n.jsxs(T,{align:"middle",children:[i.isGroup?n.jsx(I,{arrow:!0,overlayStyle:{maxHeight:"350px",overflow:"auto",border:"1px dashed gray",borderRadius:"5px"},menu:{items:[{key:"-1",type:"group",label:n.jsx(S,{level:5,style:{textAlign:"center"},children:G({en:`${null==(t=i.participants)?void 0:t.length} members`,vi:`${null==(s=i.participants)?void 0:s.length} thành viên`})})},{type:"divider"},...(null==(r=null==(o=i.participants)?void 0:o.map)?void 0:r.call(o,(e=>({key:e.id,label:n.jsx("b",{children:e.name}),icon:n.jsx(M,{shape:"square",src:e.avatar}),onClick:()=>window.open(g(e.id))}))))||[]]},children:n.jsx(p,{children:i.image?n.jsx(M,{shape:"square",size:40,src:n.jsx(h,{src:i.image})}):n.jsx(M.Group,{max:{count:5},children:i.participants.filter((e=>e.id!=(null==P?void 0:P.id))).map((e=>n.jsx(M,{src:e.avatar},e.id)))})})}):n.jsx(M,{shape:"square",size:40,src:n.jsx(h,{src:i.image||u(null==(d=null==(l=i.participants)?void 0:l[0])?void 0:d.id),fallback:null==(m=null==(c=i.participants)?void 0:c[0])?void 0:m.avatar})}),n.jsx("a",{href:i.url,target:"_blank",style:{marginLeft:"10px"},children:n.jsx("b",{children:i.name})})]})},filters:[{text:G({en:"Inactive (",vi:"Không hoạt động ("})+_.filter(F).length+")",value:"inactive"}],onFilter:(e,i)=>"inactive"!=e||F(i),onSearch:(e,i,n)=>{let a=e.toLowerCase();return n.name.toLocaleLowerCase().includes(a)||n.participants.some((e=>e.name.toLocaleLowerCase().includes(a)))},width:"auto"},{title:"Id",dataIndex:"id",key:"id",sorter:(e,i)=>e.id>i.id,onSearch:(e,i,n)=>{let a=e.toLowerCase();return n.id.includes(a)||n.participants.some((e=>e.id.includes(a)))},width:150},{title:G({en:"Messages",vi:"Tin nhắn"}),dataIndex:"count",key:"count",sorter:(e,i)=>e.count-i.count,render:(e,i,n)=>l(i.count),width:100,align:"right"},{title:G({en:"Members",vi:"Nguời"}),dataIndex:"participants",key:"participants",sorter:(e,i)=>e.participants.length-i.participants.length,render:(e,i,n)=>l(i.participants.length),width:100,align:"right"},{title:G({en:"Type",vi:"Loại"}),dataIndex:"type",key:"type",render:(e,i,n)=>i.isGroup?G({en:"Group",vi:"Nhóm"}):G({en:"Personal",vi:"Cá nhân"}),filters:[{text:G({en:"Group (",vi:"Nhóm ("})+_.filter((e=>e.isGroup)).length+")",value:!0},{text:G({en:"Personal (",vi:"Cá nhân ("})+_.filter((e=>!e.isGroup)).length+")",value:!1}],onFilter:(e,i)=>i.isGroup==e,width:100,align:"right"},{title:G({en:"Action",vi:"Hành động"}),dataIndex:"action",key:"download",render:(e,i,t)=>n.jsxs(p.Compact,{children:[n.jsx(m,{title:G({en:"First messages",vi:"Tin nhắn đầu tiên"}),children:n.jsx(a,{type:"primary",icon:n.jsx("i",{className:"fa-solid fa-clock-rotate-left"}),onClick:O(i)})}),n.jsx(m,{title:G({en:"Download messages",vi:"Tải cuộc trò chuyện"}),children:n.jsx(a,{type:"primary",icon:n.jsx("i",{className:"fa-solid fa-download"}),onClick:()=>R(i)})}),n.jsx(m,{title:G({en:"Delete (Coming soon)",vi:"Xoá (Sắp có)"}),children:n.jsx(a,{danger:!0,disabled:!0,icon:n.jsx("i",{className:"fa-solid fa-trash"})})})]}),width:150,align:"right"}];return n.jsxs("div",{style:{display:"flex",flexDirection:"column",width:"100%",height:"100%"},children:[n.jsxs(T,{align:"middle",style:{margin:16},children:[n.jsx(S,{level:3,style:{margin:0},children:G({en:"Messages manager",vi:"Quản lý tin nhắn"})}),n.jsx(c,{style:{marginLeft:"10px",fontWeight:"bold",color:"#888"},children:_.length}),n.jsx(m,{title:G({en:'Can only view messages that not have "End to end encryption" (e2ee)',vi:'Chỉ có thể xem tin nhắn không bị "Mã hoá đầu cuối" (e2ee)'}),children:n.jsx(c,{color:"orange",icon:n.jsx("i",{className:"fa-solid fa-lock-open"}),children:" "+G({en:"Only none e2ee",vi:"Không bị mã hoá đầu cuối"})})})]}),n.jsx(N,{data:_,columns:X,size:"small",searchable:!0,selectable:!0,keyExtractor:e=>e.id,style:{flex:1,maxHeight:"100%"},renderTitle:e=>n.jsxs(n.Fragment,{children:[n.jsx(a,{type:"primary",icon:H?n.jsx("i",{className:"fa-solid fa-rotate-right fa-spin"}):n.jsx("i",{className:"fa-solid fa-rotate-right"}),onClick:z,children:G({en:"Reload",vi:"Tải lại"})}),n.jsx(j,{data:e.length?e:_,options:[{key:"uid",label:".txt (uid)",prepareData:e=>({fileName:"messages_uid.txt",data:A(e).map((e=>e.uid)).join("\n")})},{key:"uid_name",label:".csv (uid+name)",prepareData:e=>({fileName:"messages_uid_name.csv",data:x(A(e))})},{key:"json",label:".json",prepareData:e=>({fileName:"messages.json",data:JSON.stringify(e,null,2)})},{key:"csv",label:".csv",prepareData:e=>({fileName:"messages.csv",data:x(e.map((e=>({...e,participants:e.participants.map((e=>e.name)).join(", "),participantIds:e.participants.map((e=>e.id)).join(", ")}))))})}]}),n.jsxs(p.Compact,{children:[n.jsx(m,{title:G({en:"Delete selected (Coming soon)",vi:"Xoá lựa chọn (Sắp có)"}),children:n.jsx(a,{danger:!0,disabled:!0,icon:n.jsx("i",{className:"fa-solid fa-trash-can"}),onClick:()=>{return i=e,void console.log(i);var i},children:G({en:"Delete",vi:"Xoá"})+(e.length?" "+e.length:"")})}),n.jsx(m,{title:e.length?G({en:"Download "+e.length+" messages",vi:"Tải "+e.length+" cuộc trò chuyện"}):G({en:"Select messages to download",vi:"Chọn cuộc trò chuyện để tải"}),children:n.jsxs(a,{disabled:!(null==e?void 0:e.length),icon:n.jsx("i",{className:"fa-solid fa-download"}),onClick:()=>(async e=>{if(!(await k()))return;r("AllMessages:onClickDownloadMultipleThreads");for(let i of e)if(await R(i))break})(e),children:[G({en:"Download ",vi:"Tải "})," ",e.length||""]})})]}),n.jsx(D,{type:"new",children:n.jsx(m,{title:G({en:"How to delete all conversations",vi:"Cách xoá tất cả cuộc trò chuyện"}),children:n.jsx(a,{href:"https://www.facebook.com/groups/fbaio/posts/1617211938933488",target:"_blank",icon:n.jsx("i",{className:"fa-solid fa-arrow-up-right-from-square"}),iconPosition:"end",children:G({en:"Delete all",vi:"Xoá tất cả"})})})})]})})]})}export{L as default};
